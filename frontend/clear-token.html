<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¸…é™¤ Token å·¥å…·</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .container {
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            text-align: center;
            max-width: 500px;
        }
        h1 {
            color: #333;
            margin-bottom: 20px;
        }
        .info {
            background: #f0f0f0;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            text-align: left;
        }
        .info p {
            margin: 5px 0;
            font-size: 14px;
        }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px;
            transition: background 0.3s;
        }
        button:hover {
            background: #5568d3;
        }
        .success {
            color: #4caf50;
            font-weight: bold;
            margin-top: 20px;
        }
        .error {
            color: #f44336;
            font-weight: bold;
            margin-top: 20px;
        }
        #result {
            margin-top: 20px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ æ¸…é™¤ Token å·¥å…·</h1>
        
        <div class="info">
            <p><strong>å½“å‰ Token çŠ¶æ€ï¼š</strong></p>
            <p id="tokenStatus">æ£€æŸ¥ä¸­...</p>
        </div>

        <button onclick="clearAllTokens()">ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰ Token</button>
        <button onclick="checkToken()">ğŸ” æ£€æŸ¥ Token</button>
        
        <div id="result"></div>
    </div>

    <script>
        // æ£€æŸ¥ Token
        function checkToken() {
            const tokens = {
                'user_token': localStorage.getItem('user_token'),
                'token': localStorage.getItem('token'),
                'user_info': localStorage.getItem('user_info'),
                'admin_token': localStorage.getItem('admin_token'),
                'wiki_admin_token': localStorage.getItem('wiki_admin_token')
            };

            let html = '<div class="info" style="text-align: left;">';
            let hasToken = false;

            for (const [key, value] of Object.entries(tokens)) {
                if (value) {
                    hasToken = true;
                    html += `<p><strong>${key}:</strong> ${value.substring(0, 50)}...</p>`;
                    
                    // å°è¯•è§£ç  JWT
                    if (value.includes('.')) {
                        try {
                            const parts = value.split('.');
                            const payload = JSON.parse(atob(parts[1]));
                            html += `<p style="margin-left: 20px; color: #666;">
                                ç”¨æˆ·ID: ${payload.sub || 'N/A'}<br>
                                è¿‡æœŸæ—¶é—´: ${new Date(payload.exp * 1000).toLocaleString('zh-CN')}<br>
                                ${Date.now() > payload.exp * 1000 ? '<span style="color: red;">âš ï¸ å·²è¿‡æœŸ</span>' : '<span style="color: green;">âœ… æœ‰æ•ˆ</span>'}
                            </p>`;
                        } catch (e) {
                            html += `<p style="margin-left: 20px; color: red;">âš ï¸ æ— æ³•è§£æ</p>`;
                        }
                    }
                }
            }

            if (!hasToken) {
                html += '<p style="color: green;">âœ… æ²¡æœ‰æ‰¾åˆ°ä»»ä½• Token</p>';
            }

            html += '</div>';
            document.getElementById('result').innerHTML = html;
        }

        // æ¸…é™¤æ‰€æœ‰ Token
        function clearAllTokens() {
            if (!confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰ Token å—ï¼Ÿæ¸…é™¤åéœ€è¦é‡æ–°ç™»å½•ã€‚')) {
                return;
            }

            // 1. æ¸…é™¤ localStorage
            const keysToRemove = [
                'user_token',
                'token',
                'user_info',
                'user_token_expires_at',
                'admin_token',
                'wiki_admin_token'
            ];

            let cleared = [];
            keysToRemove.forEach(key => {
                if (localStorage.getItem(key)) {
                    localStorage.removeItem(key);
                    cleared.push(key);
                }
            });

            // 2. æ¸…é™¤ sessionStorage
            sessionStorage.clear();

            // 3. æ¸…é™¤æ‰€æœ‰ Cookie
            document.cookie.split(";").forEach(function(c) { 
                document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/"); 
            });

            // 4. æ¸…é™¤ IndexedDBï¼ˆå¦‚æœæœ‰ï¼‰
            if (window.indexedDB) {
                indexedDB.databases().then(dbs => {
                    dbs.forEach(db => {
                        if (db.name) indexedDB.deleteDatabase(db.name);
                    });
                }).catch(() => {});
            }

            // æ˜¾ç¤ºç»“æœ
            let resultHtml = '<div class="success">';
            resultHtml += '<p>âœ… Token æ¸…é™¤æˆåŠŸï¼</p>';
            if (cleared.length > 0) {
                resultHtml += '<p>å·²æ¸…é™¤ï¼š' + cleared.join(', ') + '</p>';
            }
            resultHtml += '<p>3 ç§’åå°†è·³è½¬åˆ°ç™»å½•é¡µé¢...</p>';
            resultHtml += '</div>';

            document.getElementById('result').innerHTML = resultHtml;

            // 3ç§’åè·³è½¬
            setTimeout(() => {
                window.location.href = 'http://localhost:5173/user/login';
            }, 3000);
        }

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥
        window.onload = function() {
            const userToken = localStorage.getItem('user_token');
            const tokenStatus = document.getElementById('tokenStatus');
            
            if (userToken) {
                try {
                    const parts = userToken.split('.');
                    const payload = JSON.parse(atob(parts[1]));
                    const isExpired = Date.now() > payload.exp * 1000;
                    
                    tokenStatus.innerHTML = `
                        <span style="color: ${isExpired ? 'red' : 'orange'};">
                            ${isExpired ? 'âš ï¸ Token å·²è¿‡æœŸ' : 'âš ï¸ å‘ç°æ—§ Token'}
                        </span><br>
                        <small>ç”¨æˆ·ID: ${payload.sub}, è¿‡æœŸæ—¶é—´: ${new Date(payload.exp * 1000).toLocaleString('zh-CN')}</small>
                    `;
                } catch (e) {
                    tokenStatus.innerHTML = '<span style="color: red;">âš ï¸ Token æ ¼å¼é”™è¯¯</span>';
                }
            } else {
                tokenStatus.innerHTML = '<span style="color: green;">âœ… æ²¡æœ‰ Token</span>';
            }
        };
    </script>
</body>
</html>
