<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>æµå›¾é€š</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: #f5f7fa;
      }

      #app {
        height: 100vh;
        display: flex;
        flex-direction: column;
      }

      .header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .container {
        flex: 1;
        display: flex;
        overflow: hidden;
      }

      .sidebar {
        width: 300px;
        background: white;
        border-right: 1px solid #e0e0e0;
        overflow-y: auto;
        transition: all 0.3s ease;
      }
      
      .sidebar.collapsed {
        width: 0;
        overflow: hidden;
      }

      .sidebar-header {
        padding: 15px 20px;
        border-bottom: 1px solid #e0e0e0;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      
      .layer-filter-btn {
        padding: 6px 12px;
        background: #f5f7fa;
        border: 1px solid #ddd;
        border-radius: 4px;
        cursor: pointer;
        font-size: 13px;
        transition: all 0.3s;
      }
      
      .layer-filter-btn:hover {
        background: #e8eaf0;
      }
      
      .layer-filter-btn.active {
        background: #667eea;
        color: white;
        border-color: #667eea;
      }
      
      .layer-filter-panel {
        background: #f9fafb;
        border-bottom: 1px solid #e0e0e0;
        padding: 15px;
        animation: slideDown 0.3s ease;
      }
      
      @keyframes slideDown {
        from {
          opacity: 0;
          max-height: 0;
          padding: 0 15px;
        }
        to {
          opacity: 1;
          max-height: 500px;
          padding: 15px;
        }
      }
      
      .filter-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
        font-weight: 600;
        font-size: 14px;
        color: #333;
      }
      
      .filter-actions {
        display: flex;
        gap: 8px;
      }
      
      .filter-action-btn {
        padding: 4px 10px;
        background: white;
        border: 1px solid #ddd;
        border-radius: 3px;
        cursor: pointer;
        font-size: 12px;
        transition: all 0.2s;
      }
      
      .filter-action-btn:hover {
        background: #667eea;
        color: white;
        border-color: #667eea;
      }
      
      .category-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      
      .category-item {
        display: flex;
        align-items: center;
        padding: 10px 12px;
        background: white;
        border: 2px solid #e0e0e0;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.3s;
      }
      
      .category-item:hover {
        border-color: #667eea;
        transform: translateX(3px);
      }
      
      .category-item.active {
        background: #667eea;
        border-color: #667eea;
        color: white;
      }
      
      .category-icon {
        font-size: 20px;
        margin-right: 10px;
      }
      
      .category-name {
        flex: 1;
        font-size: 14px;
        font-weight: 500;
      }
      
      .category-check {
        font-size: 18px;
        font-weight: bold;
        opacity: 0;
        transition: opacity 0.3s;
      }
      
      .category-item.active .category-check {
        opacity: 1;
      }
      .search-box {
        margin: 20px;
      }
      .search-box input {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 14px;
      }

      .building-list {
        padding: 0 20px 20px;
      }
      .building-category {
        margin-bottom: 20px;
      }
      .category-title {
        font-weight: bold;
        color: #667eea;
        margin-bottom: 10px;
        font-size: 14px;
      }

      .building-item {
        padding: 10px;
        margin-bottom: 5px;
        border-radius: 5px;
        cursor: pointer;
        border-left: 3px solid transparent;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .building-item:hover {
        background: #f5f7fa;
        border-left-color: #667eea;
      }

      .building-info {
        flex: 1;
      }

      .favorite-btn {
        background: none;
        border: none;
        cursor: pointer;
        font-size: 20px;
        padding: 5px;
        line-height: 1;
        transition: transform 0.2s;
        color: #d1d5db;
      }

      .favorite-btn:hover {
        transform: scale(1.2);
      }

      .favorite-btn:active {
        transform: scale(0.9);
      }

      .favorite-btn.active {
        color: #f472b6;
        text-shadow: 0 0 6px rgba(244, 114, 182, 0.6);
        transform: scale(1.1);
      }

      .navigation-panel {
        padding: 20px;
        border-bottom: 1px solid #e0e0e0;
        background: #f9fafb;
      }

      .nav-title {
        font-weight: bold;
        color: #667eea;
        margin-bottom: 15px;
        font-size: 14px;
      }

      .nav-input-group {
        margin-bottom: 10px;
      }

      .nav-input-group label {
        display: block;
        font-size: 12px;
        color: #666;
        margin-bottom: 5px;
      }

      .nav-input-group select {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 14px;
      }

      .nav-button {
        width: 100%;
        padding: 10px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
        margin-top: 10px;
        font-weight: 500;
        transition: all 0.3s ease;
        box-shadow: 0 2px 4px rgba(102, 126, 234, 0.3);
      }

      .nav-button:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(102, 126, 234, 0.4);
      }

      .nav-button:active {
        transform: translateY(0);
      }

      .nav-button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .clear-button {
        background: #e0e0e0;
        color: #666;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .clear-button:hover {
        background: #d0d0d0;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
      }

      .route-info {
        margin-top: 15px;
        padding: 12px;
        background: linear-gradient(135deg, #e8f5e9 0%, #e3f2fd 100%);
        border-radius: 8px;
        font-size: 13px;
        border: 1px solid #b2dfdb;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      }

      .route-info p {
        margin: 8px 0;
        color: #2c3e50;
      }

      .route-info p:first-child {
        margin-top: 0;
      }

      .route-info p:last-child {
        margin-bottom: 0;
      }

      .map-pick-btn {
        background: #34c759;
        font-size: 12px;
        padding: 5px 10px;
        margin-left: 5px;
        border: none;
        border-radius: 3px;
        color: white;
        cursor: pointer;
      }

      .map-pick-btn:hover {
        opacity: 0.8;
      }

      .map-pick-btn.active {
        background: #ff9500;
      }

      .pick-hint {
        font-size: 11px;
        color: #ff9500;
        margin-top: 5px;
        font-style: italic;
      }

      .favorites-quick-access {
        padding: 15px 20px;
        border-bottom: 1px solid #e0e0e0;
        background: #fff9e6;
      }

      .favorites-title {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-weight: bold;
        color: #667eea;
        margin-bottom: 10px;
        font-size: 14px;
      }

      .favorites-list {
        display: flex;
        flex-direction: column;
        gap: 5px;
      }

      .favorite-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 10px;
        background: white;
        border-radius: 5px;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 13px;
      }

      .favorite-item:hover {
        background: #f5f7fa;
        transform: translateX(3px);
      }

      .favorite-btn-small {
        background: none;
        border: none;
        cursor: pointer;
        font-size: 16px;
        padding: 0;
        line-height: 1;
        transition: transform 0.2s;
        color: #d1d5db;
      }

      .favorite-btn-small:hover {
        transform: scale(1.2);
      }

      .favorite-btn-small.active {
        color: #f472b6;
        text-shadow: 0 0 4px rgba(244, 114, 182, 0.6);
      }

      .favorite-route-button {
        width: 100%;
        margin-top: 10px;
        padding: 8px 16px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.3s ease;
      }

      .favorite-route-button:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
      }

      .favorite-route-button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .share-route-button {
        width: 100%;
        margin-top: 8px;
        padding: 8px 16px;
        background: linear-gradient(135deg, #34c759 0%, #30a14e 100%);
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.3s ease;
      }

      .share-route-button:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(52, 199, 89, 0.4);
      }

      .share-route-button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .favorite-routes-section {
        margin-bottom: 20px;
        padding-bottom: 20px;
        border-bottom: 1px solid #e0e0e0;
      }

      .favorite-routes-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .favorite-route-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px;
        background: #f9fafb;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .favorite-route-item:hover {
        background: #f3f4f6;
        transform: translateX(3px);
      }

      .route-item-content {
        flex: 1;
      }

      .route-item-name {
        font-size: 14px;
        font-weight: 500;
        color: #1f2937;
        margin-bottom: 4px;
      }

      .route-item-info {
        display: flex;
        gap: 12px;
        font-size: 12px;
        color: #6b7280;
      }

      .map-container {
        flex: 1;
        position: relative;
        background: white;
      }

      .map-wrapper {
        width: 100%;
        height: 100%;
      }

      .info-panel {
        position: absolute;
        top: 20px;
        right: 20px;
        background: white;
        padding: 15px;
        border-radius: 10px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        min-width: 250px;
        max-width: 350px;
      }

      .close-btn {
        position: absolute;
        top: 5px;
        right: 10px;
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: #999;
      }

      .stats {
        background: white;
        border-top: 1px solid #e0e0e0;
        display: flex;
        justify-content: space-around;
        padding: 15px;
      }

      .stat-item {
        text-align: center;
      }

      .stat-value {
        font-size: 24px;
        font-weight: bold;
        color: #667eea;
      }

      .stat-label {
        font-size: 12px;
        color: #666;
        margin-top: 5px;
      }

      .coordinate-display {
        position: absolute;
        bottom: 20px;
        left: 20px;
        background: rgba(255, 255, 255, 0.95);
        padding: 10px 15px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        font-family: monospace;
        font-size: 14px;
        z-index: 1000;
      }

      .coordinate-display strong {
        color: #667eea;
      }

      .copy-hint {
        display: block;
        margin-top: 5px;
        font-size: 12px;
        color: #999;
        font-style: italic;
      }

      .copy-message {
        position: absolute;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(102, 126, 234, 0.95);
        color: white;
        padding: 10px 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        font-size: 14px;
        z-index: 2000;
        animation: fadeIn 0.3s;
        white-space: nowrap;
      }

      .copy-message.success {
        background: rgba(52, 199, 89, 0.95);
      }

      .copy-message.error {
        background: rgba(255, 59, 48, 0.95);
      }

      .copy-message.warning {
        background: rgba(255, 149, 0, 0.95);
      }

      .copy-message.info {
        background: rgba(102, 126, 234, 0.95);
      }

      /* åˆ«ç§°è¾“å…¥å¼¹çª— */
      .alias-dialog-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        animation: fadeIn 0.2s ease;
      }

      .alias-dialog {
        background: white;
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        width: 90%;
        max-width: 400px;
        animation: slideUp 0.3s ease;
      }

      .alias-dialog-header {
        padding: 20px;
        border-bottom: 1px solid #e0e0e0;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .alias-dialog-header h3 {
        margin: 0;
        font-size: 18px;
        color: #1f2937;
      }

      .alias-dialog-header .close-btn {
        background: none;
        border: none;
        font-size: 28px;
        color: #999;
        cursor: pointer;
        padding: 0;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: all 0.2s;
      }

      .alias-dialog-header .close-btn:hover {
        background: #f3f4f6;
        color: #666;
      }

      .alias-dialog-body {
        padding: 20px;
      }

      .alias-hint {
        margin: 0 0 15px 0;
        color: #6b7280;
        font-size: 14px;
      }

      .alias-input {
        width: 100%;
        padding: 12px;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        font-size: 14px;
        transition: border-color 0.2s;
        box-sizing: border-box;
      }

      .alias-input:focus {
        outline: none;
        border-color: #667eea;
      }

      .alias-length {
        margin: 8px 0 0 0;
        text-align: right;
        font-size: 12px;
        color: #9ca3af;
      }

      .alias-dialog-footer {
        padding: 15px 20px;
        border-top: 1px solid #e0e0e0;
        display: flex;
        gap: 10px;
        justify-content: flex-end;
      }

      .btn-cancel,
      .btn-confirm {
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s;
      }

      .btn-cancel {
        background: #f3f4f6;
        color: #6b7280;
      }

      .btn-cancel:hover {
        background: #e5e7eb;
      }

      .btn-confirm {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }

      .btn-confirm:hover:not(:disabled) {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
      }

      .btn-confirm:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }

      @keyframes slideUp {
        from {
          transform: translateY(20px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }
      
      /* ä¾§è¾¹æ æ”¶èµ·æŒ‰é’® */
      .toggle-sidebar-btn {
        position: fixed;
        left: 310px;
        top: 50%;
        transform: translateY(-50%);
        width: 32px;
        height: 64px;
        background: white;
        border: 1px solid #e0e0e0;
        border-left: none;
        border-radius: 0 8px 8px 0;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        z-index: 100;
        box-shadow: 2px 0 8px rgba(0,0,0,0.1);
      }
      
      .toggle-sidebar-btn:hover {
        background: #f5f7fa;
        width: 36px;
      }
      
      .toggle-sidebar-btn.collapsed {
        left: 10px;
      }
      
      .toggle-sidebar-btn svg {
        width: 20px;
        height: 20px;
        transition: transform 0.3s ease;
      }
      
      .toggle-sidebar-btn.collapsed svg {
        transform: rotate(180deg);
      }
    </style>
  </head>
  <body>
    <div id="app">

      <div class="container">
        <div class="sidebar" :class="{collapsed: sidebarCollapsed}">
          <div class="sidebar-header">
            <h2>ğŸ“ æ ¡å›­å»ºç­‘</h2>
            <button class="layer-filter-btn" @click="toggleLayerFilter" :class="{active: layerFilterVisible}">
              ğŸ“Š å›¾å±‚ç­›é€‰
            </button>
          </div>

          <!-- å›¾å±‚ç­›é€‰é¢æ¿ -->
          <div class="layer-filter-panel" v-if="layerFilterVisible">
            <div class="filter-header">
              <span>é€‰æ‹©æ˜¾ç¤ºç±»åˆ«</span>
              <div class="filter-actions">
                <button class="filter-action-btn" @click="selectAllCategories">å…¨é€‰</button>
                <button class="filter-action-btn" @click="deselectAllCategories">æ¸…ç©º</button>
              </div>
            </div>
            <div class="category-list">
              <div 
                v-for="category in categoryDefinitions" 
                :key="category.id"
                class="category-item"
                :class="{active: activeCategories.includes(category.id)}"
                @click="toggleCategory(category.id)"
              >
                <span class="category-icon">{{ category.icon }}</span>
                <span class="category-name">{{ category.name }}</span>
                <span class="category-check">âœ“</span>
              </div>
            </div>
          </div>

          <div class="navigation-panel">
            <div class="nav-title">ğŸ§­ è·¯çº¿å¯¼èˆª</div>
            <div class="nav-input-group">
              <label>èµ·ç‚¹</label>
              <div style="display: flex; align-items: center">
                <select v-model="navStart" style="flex: 1">
                  <option value="">è¯·é€‰æ‹©èµ·ç‚¹</option>
                  <option v-for="building in allBuildings" :key="building.id" :value="building.id">
                    {{ getBuildingName(building.id) }}
                  </option>
                  <option value="custom_start" v-if="customStart">ğŸ“ åœ°å›¾é€‰ç‚¹</option>
                </select>
                <button
                  class="map-pick-btn"
                  :class="{active: pickingStart}"
                  @click="togglePickStart"
                >
                  {{ pickingStart ? 'å–æ¶ˆ' : 'é€‰ç‚¹' }}
                </button>
              </div>
              <div class="pick-hint" v-if="pickingStart">ç‚¹å‡»åœ°å›¾é€‰æ‹©èµ·ç‚¹ä½ç½®</div>
            </div>
            <div class="nav-input-group">
              <label>ç»ˆç‚¹</label>
              <div style="display: flex; align-items: center">
                <select v-model="navEnd" style="flex: 1">
                  <option value="">è¯·é€‰æ‹©ç»ˆç‚¹</option>
                  <option v-for="building in allBuildings" :key="building.id" :value="building.id">
                    {{ getBuildingName(building.id) }}
                  </option>
                  <option value="custom_end" v-if="customEnd">ğŸ“ åœ°å›¾é€‰ç‚¹</option>
                </select>
                <button class="map-pick-btn" :class="{active: pickingEnd}" @click="togglePickEnd">
                  {{ pickingEnd ? 'å–æ¶ˆ' : 'é€‰ç‚¹' }}
                </button>
              </div>
              <div class="pick-hint" v-if="pickingEnd">ç‚¹å‡»åœ°å›¾é€‰æ‹©ç»ˆç‚¹ä½ç½®</div>
            </div>
            <button class="nav-button" @click="planRoute" :disabled="!navStart || !navEnd">
              å¼€å§‹å¯¼èˆª
            </button>
            <button class="nav-button clear-button" @click="clearRoute" v-if="routeInfo">
              æ¸…é™¤è·¯çº¿
            </button>
            <div class="route-info" v-if="routeInfo">
              <p><strong>ğŸ“ è·ç¦»ï¼š</strong>{{ routeInfo.distance }}</p>
              <p><strong>ğŸš¶ æ­¥è¡Œæ—¶é—´ï¼š</strong>{{ routeInfo.walkTime }}</p>
              <p><strong>ğŸš´ éª‘è¡Œæ—¶é—´ï¼š</strong>{{ routeInfo.bikeTime }}</p>
              <button 
                class="favorite-route-button" 
                @click="toggleRouteFavorite"
                :disabled="isSavingRoute"
              >
                <span v-if="!isSavingRoute">
                  {{ isRouteFavorited ? 'â­ å·²æ”¶è—è·¯çº¿' : 'â˜† æ”¶è—è·¯çº¿' }}
                </span>
                <span v-else>å¤„ç†ä¸­...</span>
              </button>
              <button 
                class="share-route-button" 
                @click="shareRoute"
                :disabled="isGeneratingImage"
              >
                <span v-if="!isGeneratingImage">
                  ğŸ“¤ åˆ†äº«è·¯çº¿
                </span>
                <span v-else>ç”Ÿæˆä¸­...</span>
              </button>
            </div>
          </div>

          <div class="favorites-quick-access" v-if="favorites.length > 0">
            <div class="favorites-title">
              <span>â­ æˆ‘çš„æ”¶è— ({{ favorites.length }})</span>
              <a
                href="/my-favorites"
                target="_parent"
                style="font-size: 12px; color: #667eea; text-decoration: none"
                >æŸ¥çœ‹å…¨éƒ¨</a
              >
            </div>
            <div class="favorites-list">
              <div
                v-for="favId in favorites.slice(0, 3)"
                :key="favId"
                class="favorite-item"
                @click="navigateToWiki(favId)"
              >
                <span>{{ getBuildingName(favId) }}</span>
                <button
                  class="favorite-btn-small"
                  :class="{ active: favorites.includes(favId) }"
                  @click.stop="toggleFavorite(favId)"
                  title="å–æ¶ˆæ”¶è—"
                >
                  â¤ï¸
                </button>
              </div>
            </div>
          </div>

          <!-- æ”¶è—è·¯çº¿åˆ—è¡¨ -->
          <div class="favorite-routes-section" v-if="favoriteRoutes.length > 0">
            <div class="favorites-title">
              <span>ğŸ“ æ”¶è—è·¯çº¿ ({{ favoriteRoutes.length }})</span>
              <a
                href="/my-routes"
                target="_parent"
                style="font-size: 12px; color: #667eea; text-decoration: none"
                >æŸ¥çœ‹å…¨éƒ¨</a
              >
            </div>
            <div class="favorite-routes-list">
              <div
                v-for="route in favoriteRoutes.slice(0, 3)"
                :key="route.id"
                class="favorite-route-item"
                @click="loadFavoriteRoute(route)"
              >
                <div class="route-item-content">
                  <div class="route-item-name">
                    {{ route.name || `${route.startName} â†’ ${route.endName}` }}
                  </div>
                  <div class="route-item-info">
                    <span>ğŸ“ {{ route.distance }}</span>
                    <span>ğŸš¶ {{ route.walkTime }}</span>
                  </div>
                </div>
                <button
                  class="favorite-btn-small"
                  @click.stop="removeRouteFavorite(route.id)"
                  title="å–æ¶ˆæ”¶è—"
                >
                  âœ–ï¸
                </button>
              </div>
            </div>
          </div>

          <div class="search-box">
            <input type="text" v-model="searchQuery" placeholder="æœç´¢å»ºç­‘..." />
          </div>

          <div class="building-list">
            <div
              class="building-category"
              v-for="category in filteredCategories"
              :key="category.name"
            >
              <div class="category-title">{{ category.name }}</div>
              <div class="building-item" v-for="building in category.buildings" :key="building.id">
                <div class="building-info" @click="focusBuilding(building)">
                  <div class="building-name">{{ getBuildingName(building.id) }}</div>
                  <div class="building-desc">{{ getBuildingAddress(building.id) }}</div>
                </div>
                <button
                  class="favorite-btn"
                  :class="{ active: favorites.includes(building.id) }"
                  @click.stop="toggleFavorite(building.id)"
                  :title="favorites.includes(building.id) ? 'å–æ¶ˆæ”¶è—' : 'æ”¶è—'"
                >
                  {{ favorites.includes(building.id) ? 'â¤ï¸' : 'ğŸ¤' }}
                </button>
              </div>
            </div>
          </div>
        </div>
        
        <!-- ä¾§è¾¹æ æ”¶èµ·æŒ‰é’® -->
        <button class="toggle-sidebar-btn" :class="{collapsed: sidebarCollapsed}" @click="toggleSidebar" title="æ”¶èµ·/å±•å¼€ä¾§è¾¹æ ">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
          </svg>
        </button>

        <div class="map-container">
          <el-amap
            ref="map"
            vid="campusMap"
            :center="center"
            :zoom="zoom"
            :plugin="plugins"
            :events="mapEvents"
            class="map-wrapper"
          >
            <el-amap-marker
              v-for="building in filteredBuildings"
              :key="building.id"
              :position="building.position"
              :visible="currentZoom >= minZoomForMarkers"
              :events="{
                            click: () => showBuildingInfo(building)
                        }"
            >
            </el-amap-marker>

            <el-amap-info-window
              v-if="selectedBuilding"
              :position="selectedBuilding.position"
              :content="formatInfoContent(selectedBuilding)"
              :open="infoWindowOpen"
            >
            </el-amap-info-window>
          </el-amap>

          <div class="copy-message" :class="messageType" v-if="copyMessage">{{ copyMessage }}</div>
          
          <!-- åˆ«ç§°è¾“å…¥å¼¹çª— -->
          <div v-if="showAliasDialog" class="alias-dialog-overlay" @click="closeAliasDialog">
            <div class="alias-dialog" @click.stop>
              <div class="alias-dialog-header">
                <h3>ğŸ·ï¸ ä¸º{{ aliasType === 'start' ? 'èµ·ç‚¹' : 'ç»ˆç‚¹' }}èµ·ä¸ªåå­—</h3>
                <button class="close-btn" @click="closeAliasDialog">Ã—</button>
              </div>
              <div class="alias-dialog-body">
                <p class="alias-hint">ä¸ºäº†æ–¹ä¾¿è®°å¿†ï¼Œè¯·ä¸º{{ aliasType === 'start' ? 'èµ·ç‚¹' : 'ç»ˆç‚¹' }}èµ·ä¸ªåˆ«ç§°ï¼š</p>
                <input
                  v-model="aliasInput"
                  type="text"
                  class="alias-input"
                  placeholder="ä¾‹å¦‚ï¼šæˆ‘çš„å®¿èˆã€å¸¸å»çš„åœ°æ–¹"
                  maxlength="20"
                  @keypress.enter="confirmAlias"
                  autofocus
                />
                <p class="alias-length">{{ aliasInput.length }}/20</p>
              </div>
              <div class="alias-dialog-footer">
                <button class="btn-cancel" @click="closeAliasDialog">å–æ¶ˆ</button>
                <button class="btn-confirm" @click="confirmAlias" :disabled="!aliasInput.trim()">
                  ç¡®å®šæ”¶è—
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="stats">
        <div class="stat-item">
          <div class="stat-value">{{ allBuildings.length }}</div>
          <div class="stat-label">å»ºç­‘æ€»æ•°</div>
        </div>
        <div class="stat-item">
          <div class="stat-value">{{ getCategoryTypeCount('å­¦æœ¯ç§‘ç ”') }}</div>
          <div class="stat-label">å­¦æœ¯ç§‘ç ”</div>
        </div>
        <div class="stat-item">
          <div class="stat-value">{{ getCategoryTypeCount('ç”Ÿæ´»æœåŠ¡') }}</div>
          <div class="stat-label">ç”Ÿæ´»æœåŠ¡</div>
        </div>
        <div class="stat-item">
          <div class="stat-value">{{ getCategoryTypeCount('ä¼‘é—²å¨±ä¹') }}</div>
          <div class="stat-label">ä¼‘é—²å¨±ä¹</div>
        </div>
        <div class="stat-item">
          <div class="stat-value">{{ getCategoryTypeCount('äº¤é€šè®¾æ–½') }}</div>
          <div class="stat-label">äº¤é€šè®¾æ–½</div>
        </div>
        <div class="stat-item">
          <div class="stat-value">{{ getCategoryTypeCount('è¡Œæ”¿åŠå…¬') }}</div>
          <div class="stat-label">è¡Œæ”¿åŠå…¬</div>
        </div>
      </div>
    </div>

    <!-- ä½¿ç”¨å›½å†…CDNé•œåƒ -->
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue-amap@0.5.10/dist/index.js"></script>

    <script>
      Vue.use(VueAMap)

      VueAMap.initAMapApiLoader({
        key: '160cab8ad6c50752175d76e61ef92c50',
        plugin: ['Scale', 'ToolBar', 'MapType', 'AMap.Walking'],
        v: '1.4.6',
      })

      new Vue({
        el: '#app',
        data() {
          return {
            center: [121.215, 31.2855],
            zoom: 16,
            searchQuery: '',
            currentCoords: null,
            selectedBuilding: null,
            infoWindowOpen: false,
            sidebarCollapsed: false,
            currentZoom: 16,
            minZoomForMarkers: 16,
            plugins: ['Scale', 'ToolBar', 'MapType'],
            navStart: '',
            navEnd: '',
            routeInfo: null,
            walking: null,
            routePolyline: null,
            pickingStart: false,
            pickingEnd: false,
            customStart: null,
            customEnd: null,
            startMarker: null,
            endMarker: null,
            // è·¯çº¿æ”¶è—ç›¸å…³
            favoriteRoutes: [],
            isRouteFavorited: false,
            isSavingRoute: false,
            currentRouteId: null,
            // åˆ«ç§°è¾“å…¥å¼¹çª—
            showAliasDialog: false,
            aliasInput: '',
            aliasType: '', // 'start' æˆ– 'end'
            startAlias: '',
            endAlias: '',
            // è·¯çº¿åˆ†äº«
            isGeneratingImage: false,
            // å›¾å±‚ç­›é€‰ç›¸å…³
            layerFilterVisible: false,
            activeCategories: ['å­¦æœ¯ç§‘ç ”', 'ç”Ÿæ´»æœåŠ¡', 'ä¼‘é—²å¨±ä¹', 'äº¤é€šè®¾æ–½', 'è¡Œæ”¿åŠå…¬'],
            categoryDefinitions: [
              { id: 'å­¦æœ¯ç§‘ç ”', name: 'å­¦æœ¯ç§‘ç ”', icon: 'ğŸ“š', color: '#5368df' },
              { id: 'ç”Ÿæ´»æœåŠ¡', name: 'ç”Ÿæ´»æœåŠ¡', icon: 'ğŸ½ï¸', color: '#34c759' },
              { id: 'ä¼‘é—²å¨±ä¹', name: 'ä¼‘é—²å¨±ä¹', icon: 'âš½', color: '#ff9500' },
              { id: 'äº¤é€šè®¾æ–½', name: 'äº¤é€šè®¾æ–½', icon: 'ğŸšŒ', color: '#007aff' },
              { id: 'è¡Œæ”¿åŠå…¬', name: 'è¡Œæ”¿åŠå…¬', icon: 'ğŸ¢', color: '#8e8e93' },
            ],
            // å»ºç­‘æ•°æ®å°†ä»åç«¯åŠ¨æ€åŠ è½½ï¼Œä¸å†å†™æ­»åœ¨å‰ç«¯
            buildings: [],
            copyMessage: '',
            messageType: 'info',
            favorites: [],
            isFetchingBuildings: false,

            mapEvents: {
              mousemove: (e) => {
                this.currentCoords = {
                  lng: e.lnglat.lng.toFixed(6),
                  lat: e.lnglat.lat.toFixed(6),
                }
              },
              click: (e) => {
                console.log('ç‚¹å‡»ä½ç½® - ç»åº¦:', e.lnglat.lng, 'çº¬åº¦:', e.lnglat.lat)

                // å¤„ç†åœ°å›¾é€‰ç‚¹
                if (this.pickingStart) {
                  this.setCustomStart(e.lnglat)
                } else if (this.pickingEnd) {
                  this.setCustomEnd(e.lnglat)
                }
              },
              zoomchange: () => {
                const map = this.$refs.map.$amap
                if (map) {
                  this.currentZoom = map.getZoom()
                }
              },
            },
          }
        },
        mounted() {
          window.addEventListener('keydown', this.handleKeyPress)
          window.addEventListener('message', this.handleParentMessage)
          if (window.parent !== window) {
            window.parent.postMessage({ type: 'REQUEST_FAVORITES' }, '*')
          } else {
            this.loadFavoritesFallback()
          }

          // ä»åç«¯åŒæ­¥å»ºç­‘åç§°ï¼Œä¿æŒä¸ Wiki ä¸€è‡´
          this.fetchBuildingNames()
          
          // ä»åç«¯åŠ è½½å»ºç­‘æ•°æ®
          this.loadBuildingsFromBackend()
          
          // åŠ è½½æ”¶è—è·¯çº¿
          this.loadFavoriteRoutes()
          
          // æ£€æŸ¥æ˜¯å¦æœ‰éœ€è¦åŠ è½½çš„è·¯çº¿ï¼ˆä» MyRoutes é¡µé¢è·³è½¬è¿‡æ¥ï¼‰
          this.checkAndLoadRouteFromSession()
        },
        beforeDestroy() {
          window.removeEventListener('keydown', this.handleKeyPress)
          window.removeEventListener('message', this.handleParentMessage)
        },

        computed: {
          allBuildings() {
            return this.buildings
          },
          // ç­›é€‰åçš„å»ºç­‘åˆ—è¡¨ï¼ˆæ ¹æ®å›¾å±‚é€‰æ‹©ï¼‰
          filteredBuildings() {
            return this.buildings.filter(building => {
              const categories = this.getBuildingCategories(building)
              // å¦‚æœå»ºç­‘çš„ä»»ä½•ä¸€ä¸ªç±»åˆ«åœ¨æ¿€æ´»åˆ—è¡¨ä¸­ï¼Œå°±æ˜¾ç¤º
              return categories.some(cat => this.activeCategories.includes(cat))
            })
          },
          buildingCategories() {
            const categories = {}
            this.buildings.forEach((building) => {
              // ä½¿ç”¨ category å­—æ®µè€Œä¸æ˜¯ typeï¼Œä¸å›¾å±‚ç­›é€‰ä¿æŒä¸€è‡´
              const category = building.category || 'å­¦æœ¯ç§‘ç ”'
              if (!categories[category]) {
                categories[category] = []
              }
              categories[category].push(building)
            })
            return Object.keys(categories).map((name) => ({
              name,
              buildings: categories[name],
            }))
          },
          filteredCategories() {
            if (!this.searchQuery) return this.buildingCategories
            const query = this.searchQuery.toLowerCase()
            return this.buildingCategories
              .map((cat) => ({
                name: cat.name,
                buildings: cat.buildings.filter(
                  (b) =>
                    b.name.toLowerCase().includes(query) ||
                    b.description.toLowerCase().includes(query),
                ),
              }))
              .filter((cat) => cat.buildings.length > 0)
          },
        },

        methods: {
          // ä»åç«¯åŠ è½½å»ºç­‘æ•°æ®
          async loadBuildingsFromBackend() {
            try {
              console.log('ğŸ“¡ å¼€å§‹ä»åç«¯åŠ è½½å»ºç­‘æ•°æ®...')
              const response = await fetch('/api/location/map-buildings')
              
              if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`)
              }
              
              const data = await response.json()
              console.log(`âœ… æˆåŠŸåŠ è½½ ${data.total} ä¸ªå»ºç­‘æ•°æ®`, data.buildings)

              // å°†åç«¯çš„ type å­—æ®µæ˜ å°„ä¸ºå‰ç«¯ç»Ÿä¸€ä½¿ç”¨çš„ category å­—æ®µ
              const mappedBuildings = (data.buildings || []).map((building) => {
                // åç«¯è¿”å›çš„ type ç¤ºä¾‹ï¼š"å­¦æœ¯ç§‘ç ”"ã€"ç”Ÿæ´»æœåŠ¡"
                const type = building.type
                let category = 'å­¦æœ¯ç§‘ç ”'

                // æ˜ å°„è§„åˆ™ï¼š
                // - å­¦æœ¯ç§‘ç ”ï¼šæ•™å­¦æ¥¼ã€å›¾ä¹¦é¦†ã€å­¦é™¢ç­‰
                // - ç”Ÿæ´»æœåŠ¡ï¼šç”Ÿæ´»ç›¸å…³ã€åŒ»ç–—è®¾æ–½ç­‰
                // - ä¼‘é—²å¨±ä¹ï¼šä½“è‚²ã€è‰ºæœ¯ç­‰ï¼ˆå½“å‰æ•°æ®ä¸­æš‚æœªä½¿ç”¨ï¼‰
                // - äº¤é€šè®¾æ–½ï¼šæ ¡é—¨ç­‰ï¼ˆå½“å‰æ•°æ®ä¸­æš‚æœªä½¿ç”¨ï¼‰
                // - è¡Œæ”¿åŠå…¬ï¼šç»¼åˆæœåŠ¡ã€è¡Œæ”¿æ¥¼ç­‰ï¼ˆå½“å‰æ•°æ®ä¸­æš‚æœªä½¿ç”¨ï¼‰
                if (type === 'å­¦æœ¯ç§‘ç ”') {
                  category = 'å­¦æœ¯ç§‘ç ”'
                } else if (type === 'ç”Ÿæ´»æœåŠ¡' || type === 'åŒ»ç–—è®¾æ–½') {
                  category = 'ç”Ÿæ´»æœåŠ¡'
                } else if (type === 'ä½“è‚²è®¾æ–½') {
                  category = 'ä¼‘é—²å¨±ä¹'
                } else if (type === 'æ ¡é—¨') {
                  category = 'äº¤é€šè®¾æ–½'
                } else if (type === 'ç»¼åˆæœåŠ¡' || type === 'è¡Œæ”¿åŠå…¬') {
                  category = 'è¡Œæ”¿åŠå…¬'
                }

                const mapped = {
                  ...building,
                  category,
                }

                console.log(`ğŸ›ï¸ ${mapped.name}: type = "${type}", category = "${mapped.category}"`)
                return mapped
              })

              // æ›´æ–° buildings æ•°æ®ï¼ˆä¿è¯æ¯ä¸ªå»ºç­‘éƒ½æœ‰å”¯ä¸€çš„ categoryï¼‰
              this.buildings = mappedBuildings
              
              // ä¸è‡ªåŠ¨é€‰ä¸­å»ºç­‘ï¼Œç”±ç”¨æˆ·æ‰‹åŠ¨ç‚¹å‡»
            } catch (error) {
              console.error('âŒ åŠ è½½å»ºç­‘æ•°æ®å¤±è´¥:', error)
              // å¦‚æœåŠ è½½å¤±è´¥ï¼Œä½¿ç”¨ç©ºæ•°æ®ï¼Œä¸ä½¿ç”¨å†™æ­»çš„æ•°æ®
              this.buildings = []
            }
          },
          
          // æ ¹æ®å»ºç­‘çš„ category å­—æ®µè·å–ç±»åˆ«
          getBuildingCategories(building) {
            // ç›´æ¥ä½¿ç”¨æ•°æ®ä¸­çš„ category å­—æ®µ
            // æ¯ä¸ªå»ºç­‘åªæœ‰ä¸€ä¸ªç±»åˆ«æ ‡ç­¾
            if (building.category) {
              return [building.category]
            }
            
            // å¦‚æœæ²¡æœ‰ category å­—æ®µï¼Œé»˜è®¤è¿”å›å­¦æœ¯ç§‘ç ”
            return ['å­¦æœ¯ç§‘ç ”']
          },
          // åˆ‡æ¢å›¾å±‚ç­›é€‰é¢æ¿
          toggleLayerFilter() {
            this.layerFilterVisible = !this.layerFilterVisible
          },
          // åˆ‡æ¢ä¾§è¾¹æ æ˜¾ç¤º/éšè—
          toggleSidebar() {
            this.sidebarCollapsed = !this.sidebarCollapsed
          },
          // åˆ‡æ¢ç±»åˆ«é€‰æ‹©
          toggleCategory(categoryId) {
            const index = this.activeCategories.indexOf(categoryId)
            if (index > -1) {
              // å¦‚æœå·²é€‰ä¸­ï¼Œåˆ™å–æ¶ˆé€‰ä¸­
              this.activeCategories.splice(index, 1)
            } else {
              // å¦‚æœæœªé€‰ä¸­ï¼Œåˆ™æ·»åŠ 
              this.activeCategories.push(categoryId)
            }
          },
          // å…¨é€‰
          selectAllCategories() {
            this.activeCategories = this.categoryDefinitions.map(c => c.id)
          },
          // å…¨ä¸é€‰
          deselectAllCategories() {
            this.activeCategories = []
          },
          async fetchBuildingNames() {
            // ä»åç«¯æ‹‰å–å»ºç­‘åˆ—è¡¨ï¼Œè¦†ç›–æœ¬åœ°çš„åç§°/æè¿°/åœ°å€
            try {
              this.isFetchingBuildings = true
              const response = await fetch('/api/location/wiki-list')
              if (!response.ok) {
                throw new Error('åŠ è½½å»ºç­‘åˆ—è¡¨å¤±è´¥')
              }
              const data = await response.json()
              const wikiMap = {}
              ;(data?.items || []).forEach((item) => {
                const id = Number(item.buildingId ?? item.wikiId)
                if (!Number.isNaN(id)) {
                  wikiMap[id] = {
                    name: item.name,          // ä»…åŒæ­¥åç§°
                    address: item.address,    // ä»¥åŠæ‰€å±åŒºåŸŸ/åœ°å€
                  }
                }
              })

              this.buildings = this.buildings.map((building) => {
                const wiki = wikiMap[building.id]
                if (!wiki) return building
                return {
                  ...building,
                  name: wiki.name || building.name,
                  // ä¸å†è¦†ç›–æè¿°ï¼Œé¿å…å°†å¯Œæ–‡æœ¬/é•¿æ–‡æ˜¾ç¤ºåœ¨ä¾§æ 
                  address: wiki.address || building.address,
                }
              })
            } catch (error) {
              console.error('åŠ è½½å»ºç­‘åç§°å¤±è´¥:', error)
              this.showMessage('å»ºç­‘åç§°åŠ è½½å¤±è´¥ï¼Œå·²ä½¿ç”¨æœ¬åœ°åç§°', 'warning')
            } finally {
              this.isFetchingBuildings = false
            }
          },
          getAuthToken() {
            // å°è¯•å¤šç§ token å­˜å‚¨æ–¹å¼
            return localStorage.getItem('token') || localStorage.getItem('user_token') || sessionStorage.getItem('token')
          },
          parsePosition(position) {
            // è§£æåæ ‡ï¼šæ”¯æŒæ•°ç»„ã€JSONå­—ç¬¦ä¸²ã€null
            if (!position) return null
            if (Array.isArray(position)) return position
            if (typeof position === 'string') {
              try {
                const parsed = JSON.parse(position)
                return Array.isArray(parsed) ? parsed : null
              } catch (e) {
                console.error('è§£æåæ ‡å¤±è´¥:', position, e)
                return null
              }
            }
            return null
          },
          handleParentMessage(event) {
            if (!event.data) return
            if (event.data.type === 'FAVORITES_DATA') {
              this.favorites = Array.isArray(event.data.favorites) ? event.data.favorites : []
              localStorage.setItem('favorites', JSON.stringify(this.favorites))
            } else if (event.data.type === 'FAVORITE_RESULT') {
              if (event.data.success) {
                // æ›´æ–°æœ¬åœ° favorites æ•°ç»„
                const buildingId = event.data.buildingId
                if (event.data.action === 'added') {
                  // æ·»åŠ æ”¶è—
                  if (!this.favorites.includes(buildingId)) {
                    this.favorites.push(buildingId)
                  }
                } else if (event.data.action === 'removed') {
                  // å–æ¶ˆæ”¶è—
                  this.favorites = this.favorites.filter(id => id !== buildingId)
                }
                // ä¿å­˜åˆ° localStorage
                localStorage.setItem('favorites', JSON.stringify(this.favorites))
                
                this.showMessage(
                  event.data.action === 'removed' ? 'å·²å–æ¶ˆæ”¶è—' : 'å·²æ”¶è—æˆåŠŸ',
                  'success',
                )
              } else if (event.data.message) {
                this.showMessage(event.data.message, 'error')
              }
            }
          },
          loadFavoritesFallback() {
            const savedFavorites = localStorage.getItem('favorites')
            this.favorites = savedFavorites ? JSON.parse(savedFavorites) : []
          },
          getCategoryCount(type) {
            return this.buildings.filter((b) => b.type === type).length
          },
          // ç»Ÿè®¡æ–°ç±»åˆ«çš„å»ºç­‘æ•°é‡
          getCategoryTypeCount(categoryType) {
            return this.buildings.filter(building => {
              const categories = this.getBuildingCategories(building)
              return categories.includes(categoryType)
            }).length
          },
          focusBuilding(building) {
            this.center = building.position
            this.zoom = 18
            this.showBuildingInfo(building)
          },
          focusBuildingById(buildingId) {
            const building = this.buildings.find((b) => b.id === buildingId)
            if (building) {
              this.focusBuilding(building)
            }
          },
          navigateToWiki(buildingId) {
            // å¯¹äºæ”¶è—çš„å»ºç­‘ï¼Œè·³è½¬åˆ° Wiki è¯¦æƒ…é¡µ
            if (window.parent !== window) {
              window.parent.postMessage(
                {
                  type: 'NAVIGATE_TO_LOCATION',
                  locationId: buildingId,
                },
                '*',
              )
            }
          },
          getBuildingName(buildingId) {
            // Building ID = Wiki IDï¼Œç›´æ¥ä» buildings æ•°ç»„æŸ¥æ‰¾å³å¯
            const building = this.buildings.find((b) => b.id === buildingId)
            return building ? building.name : 'æœªçŸ¥å»ºç­‘'
          },
          getBuildingDesc(buildingId) {
            // Building ID = Wiki IDï¼Œç›´æ¥ä» buildings æ•°ç»„æŸ¥æ‰¾å³å¯
            const building = this.buildings.find((b) => b.id === buildingId)
            return building ? building.description : ''
          },
          getBuildingAddress(buildingId) {
            const building = this.buildings.find((b) => b.id === buildingId)
            return building?.address || 'æœªçŸ¥åŒºåŸŸ'
          },
          showBuildingInfo(building) {
            // å¦‚æœæ­£åœ¨é€‰ç‚¹æ¨¡å¼ï¼Œå°†å»ºç­‘è®¾ç½®ä¸ºèµ·ç‚¹æˆ–ç»ˆç‚¹ï¼Œä¸è·³è½¬
            if (this.pickingStart) {
              this.navStart = String(building.id)
              this.pickingStart = false
              
              // åˆ›å»ºèµ·ç‚¹æ ‡è®°
              const map = this.$refs.map.$amap
              if (map) {
                // ç§»é™¤æ—§æ ‡è®°
                if (this.startMarker) {
                  map.remove(this.startMarker)
                }
                // åˆ›å»ºæ–°æ ‡è®°
                this.startMarker = new AMap.Marker({
                  position: building.position,
                  title: 'èµ·ç‚¹',
                  icon: new AMap.Icon({
                    size: new AMap.Size(25, 34),
                    image: '//a.amap.com/jsapi_demos/static/demo-center/icons/poi-marker-red.png',
                    imageSize: new AMap.Size(25, 34),
                  }),
                })
                map.add(this.startMarker)
              }
              
              this.showMessage(`å·²é€‰æ‹©èµ·ç‚¹ï¼š${building.name}`, 'success')
              return
            }
            
            if (this.pickingEnd) {
              this.navEnd = String(building.id)
              this.pickingEnd = false
              
              // åˆ›å»ºç»ˆç‚¹æ ‡è®°
              const map = this.$refs.map.$amap
              if (map) {
                // ç§»é™¤æ—§æ ‡è®°
                if (this.endMarker) {
                  map.remove(this.endMarker)
                }
                // åˆ›å»ºæ–°æ ‡è®°
                this.endMarker = new AMap.Marker({
                  position: building.position,
                  title: 'ç»ˆç‚¹',
                  icon: new AMap.Icon({
                    size: new AMap.Size(25, 34),
                    image: '//a.amap.com/jsapi_demos/static/demo-center/icons/poi-marker-default.png',
                    imageSize: new AMap.Size(25, 34),
                  }),
                })
                map.add(this.endMarker)
              }
              
              this.showMessage(`å·²é€‰æ‹©ç»ˆç‚¹ï¼š${building.name}`, 'success')
              return
            }

            // æ­£å¸¸æ¨¡å¼ï¼šæ‰€æœ‰å»ºç­‘éƒ½æœ‰ Wiki é¡µé¢ï¼ŒBuilding ID = Wiki ID
            // å›¾ä¹¦é¦†ç›´æ¥è·³è½¬ï¼Œä¸æ˜¾ç¤ºä¿¡æ¯çª—å£
            if (building.id === 10) {
              if (window.parent !== window) {
                window.parent.postMessage(
                  {
                    type: 'NAVIGATE_TO_LOCATION',
                    locationId: building.id,
                  },
                  '*',
                )
              }
              return
            }

            // å…¶ä»–å»ºç­‘æ˜¾ç¤ºä¿¡æ¯çª—å£
            this.selectedBuilding = building
            this.infoWindowOpen = true

            // æ‰€æœ‰å»ºç­‘éƒ½è§¦å‘è·¯ç”±è·³è½¬åˆ°å¯¹åº”çš„ Wiki é¡µé¢
            if (window.parent !== window) {
              window.parent.postMessage(
                {
                  type: 'NAVIGATE_TO_LOCATION',
                  locationId: building.id,
                },
                '*',
              )
            }
          },
          closeInfo() {
            this.selectedBuilding = null
            this.infoWindowOpen = false
          },
          formatInfoContent(building) {
            const isFavorited = this.favorites.includes(building.id)
            const heartIcon = isFavorited ? 'â¤ï¸' : 'ğŸ¤'
            const favoriteText = isFavorited ? 'å·²æ”¶è—' : 'æ”¶è—'

            return `<div style="padding: 15px; min-width: 250px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <h3 style="margin: 0; color: #252b46; font-size: 18px;">${this.getBuildingName(building.id)}</h3>
                            <button 
                                onclick="window.toggleFavorite(${building.id})" 
                                style="background: none; border: none; cursor: pointer; font-size: 24px; padding: 0; line-height: 1;"
                                title="${favoriteText}">
                                ${heartIcon}
                            </button>
                        </div>
                        <p style="margin: 8px 0; color: #666;"><strong>ç±»å‹ï¼š</strong>${building.type}</p>
                        <p style="margin: 8px 0; color: #666;"><strong>å¼€æ”¾æ—¶é—´ï¼š</strong>${building.openTime}</p>
                        <p style="margin: 8px 0; color: #666;"><strong>åœ°å€ï¼š</strong>${building.address}</p>
                    </div>`
          },
          handleKeyPress(e) {
            if ((e.key === 'c' || e.key === 'C') && this.currentCoords) {
              const coordText = `[${this.currentCoords.lng}, ${this.currentCoords.lat}]`

              navigator.clipboard
                .writeText(coordText)
                .then(() => {
                  this.showMessage('å·²å¤åˆ¶: ' + coordText, 'success')
                })
                .catch((err) => {
                  console.error('å¤åˆ¶å¤±è´¥:', err)
                  this.showMessage('å¤åˆ¶å¤±è´¥', 'error')
                })
            }
          },
          togglePickStart() {
            this.pickingStart = !this.pickingStart
            if (this.pickingStart) {
              this.pickingEnd = false
            }
          },
          togglePickEnd() {
            this.pickingEnd = !this.pickingEnd
            if (this.pickingEnd) {
              this.pickingStart = false
            }
          },
          setCustomStart(lnglat) {
            const map = this.$refs.map.$amap

            // ç§»é™¤æ—§æ ‡è®°
            if (this.startMarker) {
              map.remove(this.startMarker)
            }

            // åˆ›å»ºæ–°æ ‡è®°
            this.startMarker = new AMap.Marker({
              position: [lnglat.lng, lnglat.lat],
              title: 'èµ·ç‚¹',
              icon: new AMap.Icon({
                size: new AMap.Size(25, 34),
                image: '//a.amap.com/jsapi_demos/static/demo-center/icons/poi-marker-red.png',
                imageSize: new AMap.Size(25, 34),
              }),
            })
            map.add(this.startMarker)

            this.customStart = [lnglat.lng, lnglat.lat]
            this.navStart = 'custom_start'
            this.pickingStart = false
          },
          setCustomEnd(lnglat) {
            const map = this.$refs.map.$amap

            // ç§»é™¤æ—§æ ‡è®°
            if (this.endMarker) {
              map.remove(this.endMarker)
            }

            // åˆ›å»ºæ–°æ ‡è®°
            this.endMarker = new AMap.Marker({
              position: [lnglat.lng, lnglat.lat],
              title: 'ç»ˆç‚¹',
              icon: new AMap.Icon({
                size: new AMap.Size(25, 34),
                image: '//a.amap.com/jsapi_demos/static/demo-center/icons/poi-marker-default.png',
                imageSize: new AMap.Size(25, 34),
              }),
            })
            map.add(this.endMarker)

            this.customEnd = [lnglat.lng, lnglat.lat]
            this.navEnd = 'custom_end'
            this.pickingEnd = false
          },
          planRoute() {
            if (!this.navStart || !this.navEnd) {
              this.showMessage('è¯·é€‰æ‹©èµ·ç‚¹å’Œç»ˆç‚¹', 'warning')
              return
            }

            if (
              this.navStart === this.navEnd &&
              this.navStart !== 'custom_start' &&
              this.navEnd !== 'custom_end'
            ) {
              this.showMessage('èµ·ç‚¹å’Œç»ˆç‚¹ä¸èƒ½ç›¸åŒ', 'warning')
              return
            }

            let startPos, endPos

            // è·å–èµ·ç‚¹åæ ‡
            if (this.navStart === 'custom_start') {
              startPos = this.customStart
            } else {
              const startBuilding = this.buildings.find((b) => b.id === parseInt(this.navStart))
              if (!startBuilding) {
                this.showMessage('èµ·ç‚¹ä¿¡æ¯é”™è¯¯', 'error')
                return
              }
              startPos = startBuilding.position
            }

            // è·å–ç»ˆç‚¹åæ ‡
            if (this.navEnd === 'custom_end') {
              endPos = this.customEnd
            } else {
              const endBuilding = this.buildings.find((b) => b.id === parseInt(this.navEnd))
              if (!endBuilding) {
                this.showMessage('ç»ˆç‚¹ä¿¡æ¯é”™è¯¯', 'error')
                return
              }
              endPos = endBuilding.position
            }

            // æ¸…é™¤ä¹‹å‰çš„è·¯çº¿ï¼ˆä½†ä¿ç•™è‡ªå®šä¹‰æ ‡è®°ï¼‰
            if (this.walking) {
              this.walking.clear()
            }
            this.routeInfo = null

            // ç¡®ä¿ walking å·²åˆå§‹åŒ–
            const map = this.$refs.map.$amap
            if (!map) {
              this.showMessage('åœ°å›¾æœªåŠ è½½å®Œæˆï¼Œè¯·ç¨åå†è¯•', 'error')
              return
            }

            if (!this.walking) {
              // åŒæ­¥åˆå§‹åŒ– Walking
              this.walking = new AMap.Walking({
                map: map,
              })
            }

            // å†æ¬¡æ£€æŸ¥
            if (!this.walking) {
              this.showMessage('å¯¼èˆªåŠŸèƒ½åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', 'error')
              return
            }

            console.log('å¼€å§‹è§„åˆ’è·¯çº¿:', startPos, '->', endPos)

            // è§„åˆ’æ­¥è¡Œè·¯çº¿
            this.walking.search(startPos, endPos, (status, result) => {
              console.log('è·¯çº¿è§„åˆ’ç»“æœ:', status, result)
              if (status === 'complete') {
                if (result.routes && result.routes.length > 0) {
                  const route = result.routes[0]
                  const distance = route.distance
                  const walkTime = route.time  // æ­¥è¡Œæ—¶é—´ï¼ˆç§’ï¼‰
                  
                  // è®¡ç®—éª‘è¡Œæ—¶é—´
                  // å‡è®¾ï¼šæ­¥è¡Œé€Ÿåº¦ 5 km/hï¼Œéª‘è¡Œé€Ÿåº¦ 15 km/h
                  // éª‘è¡Œæ—¶é—´ = æ­¥è¡Œæ—¶é—´ Ã— (5/15) = æ­¥è¡Œæ—¶é—´ Ã— (1/3)
                  const bikeTime = Math.ceil(walkTime / 3)

                  this.routeInfo = {
                    distance:
                      distance >= 1000 ? (distance / 1000).toFixed(2) + ' å…¬é‡Œ' : distance + ' ç±³',
                    walkTime: walkTime >= 60 ? Math.ceil(walkTime / 60) + ' åˆ†é’Ÿ' : walkTime + ' ç§’',
                    bikeTime: bikeTime >= 60 ? Math.ceil(bikeTime / 60) + ' åˆ†é’Ÿ' : bikeTime + ' ç§’',
                  }

                  this.showMessage('è·¯çº¿è§„åˆ’æˆåŠŸï¼', 'success')
                  console.log('è·¯çº¿è§„åˆ’æˆåŠŸ:', this.routeInfo)
                  
                  // æ£€æŸ¥è¿™æ¡è·¯çº¿æ˜¯å¦å·²ç»è¢«æ”¶è—
                  this.checkIfRouteFavorited()
                }
              } else {
                this.showMessage('è·¯çº¿è§„åˆ’å¤±è´¥ï¼Œè¯·é‡è¯•', 'error')
                console.error('è·¯çº¿è§„åˆ’å¤±è´¥:', status, result)
              }
            })
          },
          clearRoute() {
            const map = this.$refs.map.$amap

            // æ¸…é™¤è·¯çº¿
            if (this.walking) {
              this.walking.clear()
            }

            // æ¸…é™¤è‡ªå®šä¹‰æ ‡è®°
            if (this.startMarker) {
              map.remove(this.startMarker)
              this.startMarker = null
            }
            if (this.endMarker) {
              map.remove(this.endMarker)
              this.endMarker = null
            }

            this.routeInfo = null
            this.navStart = ''
            this.navEnd = ''
            this.customStart = null
            this.customEnd = null
            this.pickingStart = false
            this.pickingEnd = false

            this.showMessage('è·¯çº¿å·²æ¸…é™¤', 'info')
            
            // æ¸…é™¤è·¯çº¿æ”¶è—çŠ¶æ€
            this.isRouteFavorited = false
            this.currentRouteId = null
          },
          checkAndLoadRouteFromSession() {
            try {
              const routeData = sessionStorage.getItem('loadRoute')
              if (!routeData) return
              
              const route = JSON.parse(routeData)
              console.log('æ£€æµ‹åˆ°éœ€è¦åŠ è½½çš„è·¯çº¿:', route)
              
              // æ¸…é™¤ sessionStorage
              sessionStorage.removeItem('loadRoute')
              
              // ç­‰å¾…å»ºç­‘æ•°æ®åŠ è½½å®Œæˆåå†åŠ è½½è·¯çº¿
              const loadInterval = setInterval(() => {
                if (this.buildings.length > 0) {
                  clearInterval(loadInterval)
                  this.loadRouteFromData(route)
                }
              }, 100)
              
              // è¶…æ—¶ä¿æŠ¤ï¼ˆ5ç§’ï¼‰
              setTimeout(() => {
                clearInterval(loadInterval)
                if (this.buildings.length === 0) {
                  this.showMessage('å»ºç­‘æ•°æ®åŠ è½½å¤±è´¥ï¼Œæ— æ³•åŠ è½½è·¯çº¿', 'error')
                }
              }, 5000)
            } catch (error) {
              console.error('åŠ è½½è·¯çº¿å¤±è´¥:', error)
              this.showMessage('åŠ è½½è·¯çº¿å¤±è´¥', 'error')
            }
          },
          loadRouteFromData(route) {
            console.log('å¼€å§‹åŠ è½½è·¯çº¿:', route)
            
            // è®¾ç½®èµ·ç‚¹
            if (route.startId) {
              this.navStart = String(route.startId)
            } else if (route.startPosition) {
              // è‡ªå®šä¹‰èµ·ç‚¹
              this.customStart = route.startPosition
              this.navStart = 'custom_start'
              
              // åˆ›å»ºè‡ªå®šä¹‰èµ·ç‚¹æ ‡è®°
              const map = this.$refs.map.$amap
              if (map && !this.startMarker) {
                this.startMarker = new AMap.Marker({
                  position: route.startPosition,
                  title: 'èµ·ç‚¹',
                  icon: new AMap.Icon({
                    size: new AMap.Size(25, 34),
                    image: '//a.amap.com/jsapi_demos/static/demo-center/icons/poi-marker-red.png',
                    imageSize: new AMap.Size(25, 34),
                  }),
                })
                map.add(this.startMarker)
              }
            }
            
            // è®¾ç½®ç»ˆç‚¹
            if (route.endId) {
              this.navEnd = String(route.endId)
            } else if (route.endPosition) {
              // è‡ªå®šä¹‰ç»ˆç‚¹
              this.customEnd = route.endPosition
              this.navEnd = 'custom_end'
              
              // åˆ›å»ºè‡ªå®šä¹‰ç»ˆç‚¹æ ‡è®°
              const map = this.$refs.map.$amap
              if (map && !this.endMarker) {
                this.endMarker = new AMap.Marker({
                  position: route.endPosition,
                  title: 'ç»ˆç‚¹',
                  icon: new AMap.Icon({
                    size: new AMap.Size(25, 34),
                    image: '//a.amap.com/jsapi_demos/static/demo-center/icons/poi-marker-default.png',
                    imageSize: new AMap.Size(25, 34),
                  }),
                })
                map.add(this.endMarker)
              }
            }
            
            // ç¨å¾®å»¶è¿Ÿåè§„åˆ’è·¯çº¿ï¼Œç¡®ä¿ DOM æ›´æ–°
            setTimeout(() => {
              this.planRoute()
              this.showMessage(`å·²åŠ è½½è·¯çº¿${route.name ? ': ' + route.name : ''}`, 'success')
            }, 300)
          },
          async toggleRouteFavorite() {
            if (!this.routeInfo) return
            
            const token = this.getAuthToken()
            if (!token) {
              this.showMessage('è¯·å…ˆç™»å½•', 'warning')
              // å¦‚æœåœ¨ iframe ä¸­ï¼Œå°è¯•è·³è½¬åˆ°ç™»å½•é¡µ
              if (window.parent !== window) {
                window.parent.postMessage({ type: 'NAVIGATE_TO_LOGIN' }, '*')
              }
              return
            }
            
            this.isSavingRoute = true
            
            try {
              if (this.isRouteFavorited && this.currentRouteId) {
                // å–æ¶ˆæ”¶è—
                const response = await fetch(`/api/routes/${this.currentRouteId}`, {
                  method: 'DELETE',
                  headers: {
                    'Authorization': `Bearer ${token}`
                  }
                })
                
                if (response.ok) {
                  this.showMessage('å·²å–æ¶ˆæ”¶è—è·¯çº¿', 'success')
                  // é‡æ–°åŠ è½½æ”¶è—åˆ—è¡¨ï¼Œç„¶åæ£€æŸ¥çŠ¶æ€
                  await this.loadFavoriteRoutes()
                  this.checkIfRouteFavorited()
                } else {
                  throw new Error('å–æ¶ˆæ”¶è—å¤±è´¥')
                }
              } else {
                // æ·»åŠ æ”¶è—
                // æ£€æŸ¥æ˜¯å¦æœ‰è‡ªå®šä¹‰ç‚¹
                const hasCustomStart = this.navStart === 'custom_start'
                const hasCustomEnd = this.navEnd === 'custom_end'
                
                if (hasCustomStart || hasCustomEnd) {
                  // æœ‰è‡ªå®šä¹‰ç‚¹ï¼Œæ˜¾ç¤ºåˆ«ç§°è¾“å…¥å¼¹çª—
                  this.isSavingRoute = false
                  this.startAlias = ''
                  this.endAlias = ''
                  
                  // å…ˆä¸ºèµ·ç‚¹è¾“å…¥åˆ«ç§°ï¼ˆå¦‚æœèµ·ç‚¹æ˜¯è‡ªå®šä¹‰ç‚¹ï¼‰
                  if (hasCustomStart) {
                    this.aliasType = 'start'
                    this.aliasInput = ''
                    this.showAliasDialog = true
                  } else {
                    // èµ·ç‚¹ä¸æ˜¯è‡ªå®šä¹‰ç‚¹ï¼Œç›´æ¥ä¸ºç»ˆç‚¹è¾“å…¥åˆ«ç§°
                    this.aliasType = 'end'
                    this.aliasInput = ''
                    this.showAliasDialog = true
                  }
                  return
                }
                
                // æ²¡æœ‰è‡ªå®šä¹‰ç‚¹ï¼Œç›´æ¥æ”¶è—
                const startName = this.getBuildingName(parseInt(this.navStart))
                const endName = this.getBuildingName(parseInt(this.navEnd))
                
                const routeData = {
                  startId: this.navStart === 'custom_start' ? null : parseInt(this.navStart),
                  endId: this.navEnd === 'custom_end' ? null : parseInt(this.navEnd),
                  startName: startName,
                  endName: endName,
                  startPosition: this.navStart === 'custom_start' ? this.customStart : null,
                  endPosition: this.navEnd === 'custom_end' ? this.customEnd : null,
                  distance: this.routeInfo.distance,
                  walkTime: this.routeInfo.walkTime,
                  bikeTime: this.routeInfo.bikeTime
                }
                
                const response = await fetch('/api/routes', {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                  },
                  body: JSON.stringify(routeData)
                })
                
                if (response.ok) {
                  const data = await response.json()
                  this.showMessage('è·¯çº¿æ”¶è—æˆåŠŸ', 'success')
                  // é‡æ–°åŠ è½½æ”¶è—åˆ—è¡¨ï¼Œç„¶åæ£€æŸ¥çŠ¶æ€
                  await this.loadFavoriteRoutes()
                  this.checkIfRouteFavorited()
                } else {
                  throw new Error('æ”¶è—å¤±è´¥')
                }
              }
            } catch (error) {
              console.error('è·¯çº¿æ”¶è—æ“ä½œå¤±è´¥:', error)
              this.showMessage(error.message || 'æ“ä½œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error')
            } finally {
              this.isSavingRoute = false
            }
          },
          async loadFavoriteRoutes() {
            const token = this.getAuthToken()
            if (!token) return
            
            try {
              const response = await fetch('/api/routes', {
                headers: {
                  'Authorization': `Bearer ${token}`
                }
              })
              
              if (response.ok) {
                const data = await response.json()
                // è§£æåæ ‡ JSON å­—ç¬¦ä¸²
                this.favoriteRoutes = (data.routes || []).map(route => {
                  return {
                    ...route,
                    startPosition: this.parsePosition(route.startPosition),
                    endPosition: this.parsePosition(route.endPosition)
                  }
                })
                console.log('åŠ è½½æ”¶è—è·¯çº¿:', this.favoriteRoutes)
              }
            } catch (error) {
              console.error('åŠ è½½æ”¶è—è·¯çº¿å¤±è´¥:', error)
            }
          },
          async removeRouteFavorite(routeId) {
            const token = this.getAuthToken()
            if (!token) return
            
            try {
              const response = await fetch(`/api/routes/${routeId}`, {
                method: 'DELETE',
                headers: {
                  'Authorization': `Bearer ${token}`
                }
              })
              
              if (response.ok) {
                this.showMessage('è·¯çº¿å·²åˆ é™¤', 'success')
                this.loadFavoriteRoutes()
                
                // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰è·¯çº¿
                if (this.currentRouteId === routeId) {
                  this.isRouteFavorited = false
                  this.currentRouteId = null
                }
              }
            } catch (error) {
              console.error('åˆ é™¤è·¯çº¿å¤±è´¥:', error)
              this.showMessage('åˆ é™¤å¤±è´¥', 'error')
            }
          },
          loadFavoriteRoute(route) {
            // åŠ è½½æ”¶è—çš„è·¯çº¿
            if (route.startId) {
              this.navStart = route.startId.toString()
            } else if (route.startPosition) {
              this.navStart = 'custom_start'
              this.customStart = route.startPosition
            }
            
            if (route.endId) {
              this.navEnd = route.endId.toString()
            } else if (route.endPosition) {
              this.navEnd = 'custom_end'
              this.customEnd = route.endPosition
            }
            
            // è§„åˆ’è·¯çº¿
            this.planRoute()
            
            // è®¾ç½®ä¸ºå·²æ”¶è—
            this.isRouteFavorited = true
            this.currentRouteId = route.id
          },
          checkIfRouteFavorited() {
            // æ£€æŸ¥å½“å‰è·¯çº¿æ˜¯å¦å·²ç»è¢«æ”¶è—
            if (!this.navStart || !this.navEnd || this.favoriteRoutes.length === 0) {
              this.isRouteFavorited = false
              this.currentRouteId = null
              return
            }
            
            const startId = this.navStart === 'custom_start' ? null : parseInt(this.navStart)
            const endId = this.navEnd === 'custom_end' ? null : parseInt(this.navEnd)
            const startName = this.navStart === 'custom_start' ? 'è‡ªå®šä¹‰èµ·ç‚¹' : this.getBuildingName(parseInt(this.navStart))
            const endName = this.navEnd === 'custom_end' ? 'è‡ªå®šä¹‰ç»ˆç‚¹' : this.getBuildingName(parseInt(this.navEnd))
            
            // åœ¨æ”¶è—åˆ—è¡¨ä¸­æŸ¥æ‰¾åŒ¹é…çš„è·¯çº¿
            const matchedRoute = this.favoriteRoutes.find(route => {
              // åŒ¹é…é€»è¾‘ï¼šèµ·ç‚¹å’Œç»ˆç‚¹éƒ½ç›¸åŒ
              let startMatch = false
              let endMatch = false
              
              // èµ·ç‚¹åŒ¹é…
              if (startId !== null) {
                // å»ºç­‘èµ·ç‚¹ï¼šæ¯”è¾ƒ ID å’Œåç§°
                startMatch = route.startId === startId && route.startName === startName
              } else {
                // è‡ªå®šä¹‰èµ·ç‚¹ï¼šæ¯”è¾ƒåç§°å’Œåæ ‡
                if (route.startId === null && route.startName === startName) {
                  // æ¯”è¾ƒåæ ‡ï¼ˆå…è®¸å°è¯¯å·®ï¼‰
                  if (this.customStart && route.startPosition) {
                    const pos1 = this.customStart
                    const pos2 = route.startPosition
                    const distance = Math.sqrt(
                      Math.pow(pos1[0] - pos2[0], 2) + Math.pow(pos1[1] - pos2[1], 2)
                    )
                    startMatch = distance < 0.0001 // çº¦ 10 ç±³è¯¯å·®
                  }
                }
              }
              
              // ç»ˆç‚¹åŒ¹é…
              if (endId !== null) {
                // å»ºç­‘ç»ˆç‚¹ï¼šæ¯”è¾ƒ ID å’Œåç§°
                endMatch = route.endId === endId && route.endName === endName
              } else {
                // è‡ªå®šä¹‰ç»ˆç‚¹ï¼šæ¯”è¾ƒåç§°å’Œåæ ‡
                if (route.endId === null && route.endName === endName) {
                  // æ¯”è¾ƒåæ ‡ï¼ˆå…è®¸å°è¯¯å·®ï¼‰
                  if (this.customEnd && route.endPosition) {
                    const pos1 = this.customEnd
                    const pos2 = route.endPosition
                    const distance = Math.sqrt(
                      Math.pow(pos1[0] - pos2[0], 2) + Math.pow(pos1[1] - pos2[1], 2)
                    )
                    endMatch = distance < 0.0001 // çº¦ 10 ç±³è¯¯å·®
                  }
                }
              }
              
              return startMatch && endMatch
            })
            
            if (matchedRoute) {
              this.isRouteFavorited = true
              this.currentRouteId = matchedRoute.id
              console.log('å½“å‰è·¯çº¿å·²æ”¶è—:', matchedRoute)
            } else {
              this.isRouteFavorited = false
              this.currentRouteId = null
              console.log('å½“å‰è·¯çº¿æœªæ”¶è—')
            }
          },
          closeAliasDialog() {
            this.showAliasDialog = false
            this.aliasInput = ''
            this.aliasType = ''
            this.startAlias = ''
            this.endAlias = ''
          },
          async confirmAlias() {
            const alias = this.aliasInput.trim()
            if (!alias) return
            
            // ä¿å­˜å½“å‰è¾“å…¥çš„åˆ«ç§°
            if (this.aliasType === 'start') {
              this.startAlias = alias
              
              // æ£€æŸ¥ç»ˆç‚¹æ˜¯å¦ä¹Ÿæ˜¯è‡ªå®šä¹‰ç‚¹
              if (this.navEnd === 'custom_end') {
                // ç»ˆç‚¹ä¹Ÿæ˜¯è‡ªå®šä¹‰ç‚¹ï¼Œç»§ç»­ä¸ºç»ˆç‚¹è¾“å…¥åˆ«ç§°
                this.aliasType = 'end'
                this.aliasInput = ''
                // ä¸å…³é—­å¼¹çª—ï¼Œç»§ç»­æ˜¾ç¤º
                return
              }
            } else if (this.aliasType === 'end') {
              this.endAlias = alias
            }
            
            // å…³é—­å¼¹çª—ï¼Œå¼€å§‹ä¿å­˜
            this.showAliasDialog = false
            this.isSavingRoute = true
            
            try {
              const token = this.getAuthToken()
              
              // ä½¿ç”¨åˆ«ç§°æ›¿æ¢è‡ªå®šä¹‰ç‚¹åç§°
              const startName = this.navStart === 'custom_start' ? this.startAlias : this.getBuildingName(parseInt(this.navStart))
              const endName = this.navEnd === 'custom_end' ? this.endAlias : this.getBuildingName(parseInt(this.navEnd))
              
              const routeData = {
                startId: this.navStart === 'custom_start' ? null : parseInt(this.navStart),
                endId: this.navEnd === 'custom_end' ? null : parseInt(this.navEnd),
                startName: startName,
                endName: endName,
                startPosition: this.navStart === 'custom_start' ? this.customStart : null,
                endPosition: this.navEnd === 'custom_end' ? this.customEnd : null,
                distance: this.routeInfo.distance,
                walkTime: this.routeInfo.walkTime,
                bikeTime: this.routeInfo.bikeTime
              }
              
              const response = await fetch('/api/routes', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(routeData)
              })
              
              if (response.ok) {
                this.showMessage('è·¯çº¿æ”¶è—æˆåŠŸ', 'success')
                await this.loadFavoriteRoutes()
                this.checkIfRouteFavorited()
              } else {
                throw new Error('æ”¶è—å¤±è´¥')
              }
            } catch (error) {
              console.error('è·¯çº¿æ”¶è—å¤±è´¥:', error)
              this.showMessage(error.message || 'æ”¶è—å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error')
            } finally {
              this.isSavingRoute = false
              this.aliasInput = ''
            }
          },
          async shareRoute() {
            if (!this.routeInfo) return
            
            this.isGeneratingImage = true
            
            // è·å–èµ·ç‚¹å’Œç»ˆç‚¹åç§°
            const startName = this.navStart === 'custom_start' 
              ? 'è‡ªå®šä¹‰èµ·ç‚¹' 
              : this.getBuildingName(parseInt(this.navStart))
            const endName = this.navEnd === 'custom_end' 
              ? 'è‡ªå®šä¹‰ç»ˆç‚¹' 
              : this.getBuildingName(parseInt(this.navEnd))
            
            // ç”Ÿæˆåˆ†äº«æ–‡æœ¬
            const shareText = `ğŸ—ºï¸ æµå›¾é€šè·¯çº¿åˆ†äº«\n\nğŸ“ èµ·ç‚¹ï¼š${startName}\nğŸ¯ ç»ˆç‚¹ï¼š${endName}\n\nğŸ“ è·ç¦»ï¼š${this.routeInfo.distance}\nğŸš¶ æ­¥è¡Œæ—¶é—´ï¼š${this.routeInfo.walkTime}\nğŸš´ éª‘è¡Œæ—¶é—´ï¼š${this.routeInfo.bikeTime}\n\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\nåŒæµå¤§å­¦å˜‰å®šæ ¡åŒºåœ°å›¾å¯¼èˆª`
            
            try {
              // å°è¯•ä½¿ç”¨ç°ä»£ Clipboard API
              if (navigator.clipboard && navigator.clipboard.writeText) {
                await navigator.clipboard.writeText(shareText)
                this.showMessage('è·¯çº¿ä¿¡æ¯å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success')
                console.log('âœ… è·¯çº¿ä¿¡æ¯å·²å¤åˆ¶')
              } else {
                // é™çº§æ–¹æ¡ˆï¼šä½¿ç”¨ execCommand
                throw new Error('Clipboard API not available')
              }
            } catch (error) {
              console.error('å¤åˆ¶è·¯çº¿ä¿¡æ¯å¤±è´¥:', error)
              // é™çº§æ–¹æ¡ˆ
              try {
                const textArea = document.createElement('textarea')
                textArea.value = shareText
                textArea.style.position = 'fixed'
                textArea.style.left = '-999999px'
                textArea.style.top = '0'
                document.body.appendChild(textArea)
                textArea.focus()
                textArea.select()
                const successful = document.execCommand('copy')
                document.body.removeChild(textArea)
                
                if (successful) {
                  this.showMessage('è·¯çº¿ä¿¡æ¯å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success')
                  console.log('âœ… è·¯çº¿ä¿¡æ¯å·²å¤åˆ¶ï¼ˆé™çº§æ–¹æ¡ˆï¼‰')
                } else {
                  throw new Error('execCommand failed')
                }
              } catch (fallbackError) {
                console.error('é™çº§å¤åˆ¶ä¹Ÿå¤±è´¥:', fallbackError)
                this.showMessage('å¤åˆ¶å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error')
              }
            } finally {
              this.isGeneratingImage = false
            }
          },
          showMessage(message, type = 'info') {
            // ä½¿ç”¨ç°æœ‰çš„ copyMessage æœºåˆ¶æ˜¾ç¤ºæ¶ˆæ¯
            const icons = {
              success: 'âœ“',
              error: 'âœ—',
              warning: 'âš ',
              info: 'â„¹',
            }
            this.messageType = type
            this.copyMessage = `${icons[type] || 'â„¹'} ${message}`
            setTimeout(() => {
              this.copyMessage = ''
              this.messageType = 'info'
            }, 3000)
          },
          async toggleFavorite(buildingId) {
            if (window.parent !== window) {
              window.parent.postMessage({ type: 'TOGGLE_FAVORITE', buildingId }, '*')
              return
            }

            const index = this.favorites.indexOf(buildingId)
            const buildingName = this.getBuildingName(buildingId)
            if (index > -1) {
              this.favorites.splice(index, 1)
              this.showMessage(`å·²å–æ¶ˆæ”¶è— ${buildingName}`, 'info')
            } else {
              this.favorites.push(buildingId)
              this.showMessage(`å·²æ”¶è— ${buildingName}`, 'success')
            }
            localStorage.setItem('favorites', JSON.stringify(this.favorites))
          },
        },
      })

      // å°† toggleFavorite æ–¹æ³•æš´éœ²åˆ°å…¨å±€ï¼Œä¾›ä¿¡æ¯çª—å£ä¸­çš„æŒ‰é’®è°ƒç”¨
      window.toggleFavorite = function (buildingId) {
        const app = document.querySelector('#app').__vue__
        if (app && app.toggleFavorite) {
          app.toggleFavorite(buildingId)
        }
      }
    </script>
  </body>
</html>
              
